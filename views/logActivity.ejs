<!DOCTYPE html>
<html>
    <head>
        <title><%= title %></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel='stylesheet' href='/stylesheets/style.css' />
        <link rel="manifest" href="/manifest.json">
        <script type="module" src="https://cdn.jsdelivr.net/npm/@pwabuilder/pwaauth@latest/dist/pwa-auth.min.js"></script> 
        <script type="module" src="/pwabuilder-sw-register.js"></script>
        <script type="text/javascript" src="/javascripts/logout.js"></script> 
    </head>
    <body>
        <h1><%= title %></h1>
        <h2 id='date'></h2>
        <div id="prevDay">
            <button onclick= <%= prevDay %> >Previous Day</button>
        </div>
        
        <!-- <button onclick= "decrementDate()">Previous Day</button> -->
        <div id="nextDay">
        </div>
        <br><br>

        <div id="mainSection">

        </div>
        

        <script>

            // console.log('online?:', navigator.onLine);

            var routineTypes = <%- routineTypes %>;
            var weekActivities = <%-weekActivities %>;
            var dateList = <%- dateList %>
            var startDate = <%- startDate %>;
            var routineDict = <%- routineDict %>;

            console.log(dateList);
            // console.log(weekActivities);
            console.log(routineDict);

            var dayCounter = 0;

            var currentDay = new Date();
            var currentDate = currentDay.getFullYear()+'-'+(currentDay.getMonth()+1)+'-'+(currentDay.getDate());
            const oneDay = 24 * 60 * 60 * 1000;


            var today = new Date(dateList[dayCounter])
            // console.log(today);
            // var today = new Date(startDate);
            var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+(today.getDate());
            document.getElementById('date').innerHTML = getDisplayDate(date);
            // console.log(startDate);

                
            populateMainSection()
            disableButton(today);

            function populateMainSection() {
                // if (weekActivities[dayCounter]) {
                var dateString = dateList[dayCounter];
                if (routineDict[dateString]) {
                    // var activities = JSON.stringify(weekActivities[dayCounter]);
                    document.getElementById('mainSection').innerHTML = '<div id="routine"></div>';
                    populateRoutine();

                } else {
                    console.log('currentDate:', currentDate );
                    console.log('dateString:', dateString );
                    var dateStringDate = new Date(dateString);
                    var diffDays = Math.round(Math.abs((dateStringDate - currentDay) / oneDay));
                    console.log('difference: ', diffDays);
                    if (diffDays > 3) {
                        document.getElementById('mainSection').innerHTML = '<p> You did not log anything. <br> You are unable to log information more than three days in the past.</p>';
                    } else {
                        document.getElementById('mainSection').innerHTML = '<form method="POST" id="activityForm" action="/logNewActivity"></form>';
                        document.getElementById('activityForm').innerHTML += '<div id="buttons"></div>';
                        document.getElementById('activityForm').innerHTML += '<a id="chosenDate"></a>';
                        document.getElementById('activityForm').innerHTML += '<a id="user"></a>';
                        document.getElementById('chosenDate').innerHTML = "<input type='hidden' name='chosenDate' value='" + dateList[dayCounter] + "'>";
                        populateButtons();
                        populateForm();
                    }
                    // var diffDays = Math.round(Math.abs((newDay - currentDay) / oneDay));
                    // console.log('difference: ', )

                    
                }
            }

            function populateRoutine() {
                var dateString = dateList[dayCounter];
               
                var activities = routineDict[dateString];
                // console.log('dateString: ', dateString);
                // console.log('activities: ', activities)
                // console.log('title: ', activities.title);
                // var stringActivities = JSON.stringify(weekActivities[dayCounter]);
                // var activities = JSON.parse(stringActivities);
                // console.log(activities);
                // document.getElementById('routine').innerHTML += '<p>' + activities.title + '</p>';
                document.getElementById('routine').innerHTML += '<p>' + activities.title + '</p>';
                // delete activities.title;
                // delete activities.title;
                // var keys = Object.keys(activities);
                var keys = Object.keys(activities);
                for (var i = 0; i < keys.length; i++) {
                    title = keys[i];
                    // console.log(title);
                    if ((title !== 'title') && (activities[title])) {
                        console.log('title: ', title);
                        console.log('content: ', activities[title]);
                        document.getElementById('routine').innerHTML += '<a id="'+ title +'"></a>';
                        document.getElementById(title).innerHTML += '<dt>' + title + ':</dt>';
                        if (activities[title][0] == '[') {
                            activitiesList = JSON.parse(activities[title]);
                            for (var j = 0; j < activitiesList.length; j++) {
                                if (typeof activitiesList[j] == "object") {
                                    document.getElementById(title).innerHTML += '<dd>' + activitiesList[j][0] + ' (' + activitiesList[j][1] + ') ' + '</dd>';
                                } else {
                                    document.getElementById(title).innerHTML += '<dd>' + activitiesList[j] + '</dd>';
                                }
                            }
                        } else {
                            document.getElementById(title).innerHTML += '<dd>' + activities[title] + '</dd>';
                        }
                    }
                    
                    // console.log(activities[title]);
                }
            }


            function populateButtons() {
                for (var i = 0; i < routineTypes['results'].length; i++) {
                document.getElementById('buttons').innerHTML += '<button name="activityType" value ='+routineTypes['results'][i]['routineID']+' type="submit">'+routineTypes['results'][i]['routine']+'</button>';
                document.getElementById('buttons').innerHTML += '<br>';
                console.log(routineTypes['results'][i]['routineID']);
                }

            }


            function populateForm() {
                document.getElementById('chosenDate').innerHTML = "<input type='hidden' name='chosenDate' value='" + dateList[dayCounter] + "'>";
                document.getElementById('user').innerHTML = "<input type='hidden' name='user' value='" + <%- user %> + "'>";
            }
            


            function getDisplayDate(date) {
                newToday = new Date();
                if (date == newToday.getFullYear()+'-'+(newToday.getMonth()+1)+'-'+newToday.getDate()) {
                    var displayDate = 'Today';
                } else {
                    var displayDate = date;
                }
                return displayDate
            }

            function disableButton(today) {
                newToday = new Date();
                newToday.setDate(newToday.getDate()-1);
                if (today >= newToday) {
                    document.getElementById('nextDay').innerHTML = '';
                } else {
                    document.getElementById('nextDay').innerHTML = '<button onclick=<%= nextDay %> >Next Day</button>';
                    // document.getElementById('nextDay').innerHTML = '<button onclick="incrementDate()">Next Day</button>';
                }
            }
            
            function decrementDate() {
                // today.setDate(today.getDate()-1);
                // date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+(today.getDate());

                // document.getElementById('date').innerHTML = getDisplayDate(date);
                // disableButton(today);   
                dayCounter++;
                // console.log('dayCounter: ', dayCounter)
                console.log('length: ', dateList.length);
                console.log('dayCounter: ', dayCounter);

                if ((dayCounter == (dateList.length-1)) && (!(navigator.onLine))) {
                    document.getElementById('prevDay').innerHTML = '';
                }

                if (dayCounter <= (dateList.length-1)) {
                    document.getElementById('date').innerHTML = getDisplayDate(dateList[dayCounter]);
                    var newDay = new Date(dateList[dayCounter]);
                    disableButton(newDay);
                    populateMainSection()
                } else {
                    console.log('online? ', navigator.onLine);
                    // if (navigator.onLine) {
                        var newDay = new Date(dateList[dayCounter-1]);
                        // console.log('newDay: ', newDay)
                        var diffDays = Math.round(Math.abs((newDay - currentDay) / oneDay)) + 1;
                        // console.log('diffDays: ', diffDays)
                        var weeklyOffset = Math.floor((diffDays)/7);
                        // console.log('weeklyOffset: ', weeklyOffset)
                        window.location = '/w/'+ weeklyOffset;
                    // } else {
                    //     document.getElementById('prevDay').innerHTML = '';
                    // }
                    
                }

                // document.getElementById('date').innerHTML = getDisplayDate(dateList[dayCounter]);
                // newDay = new Date(dateList[dayCounter]);
                // disableButton(newDay);
                // var diffDays = Math.round(Math.abs((newDay - currentDay) / oneDay));
                // console.log('diffDays: ', diffDays);
                // // console.log('week offset: ', Math.floor(diffDays/7));
                // var weeklyOffset = Math.floor((diffDays)/7);
                // console.log('weekOffset: ', weeklyOffset);
                // if (dayCounter > (dateList.length-1)) {
                // // if (dayCounter == 7) {
                //     window.location = '/w/'+ weeklyOffset;
                // }
                // // console.log('dayCounter: ', dayCounter);
                // // console.log(weekActivities[dayCounter]);
                // populateMainSection()
            }

            function incrementDate() { 
                document.getElementById('prevDay').innerHTML = '<button onclick= <%= prevDay %> >Previous Day</button>';

                // dayCounter--;
                
                // today.setDate(today.getDate()+1);
                // date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+(today.getDate());
                // document.getElementById('date').innerHTML = getDisplayDate(date);
                // document.getElementById('chosenDate').innerHTML = "<input type='hidden' name='chosenDate' value='" + date + "'>";
                // disableButton(today);
                // if (dayCounter == 0) {
                //     window.location = '/w/'+ weeklyOffset;
                // }
                dayCounter--;
                // console.log('dayCounter: ', dayCounter)

                if (dayCounter == -1) {
                    var newDay = new Date(dateList[dayCounter+1]);
                    var diffDays = Math.round(Math.abs((newDay - currentDay) / oneDay)) + 1;
                    // var weeklyOffset = (Math.floor((diffDays)/7) - 1);

                    // IF (r==1), location = /weeklyOffset+1
                    // console.log('href: ', window.location.href);
                    var url_string = window.location.href; //window.location.href
                    var url = new URL(url_string);
                    var r = url.searchParams.get("r");
                    // console.log('r: ', r);
                    if (r) {
                        var weeklyOffset = (Math.floor((diffDays)/7));
                        window.location = '/w/'+ weeklyOffset;
                    } else {
                        var weeklyOffset = (Math.floor((diffDays)/7) - 1);
                        window.location = '/w/'+ weeklyOffset + '?r=1';
                    }
                    // console.log(qs);
                    // console.log('weekOffset: ', weeklyOffset);
                    // window.location = '/w/'+ weeklyOffset + '?r=1';
                } else {
                    document.getElementById('date').innerHTML = getDisplayDate(dateList[dayCounter]);
                    var newDay = new Date(dateList[dayCounter]);
                    disableButton(newDay);
                    populateMainSection()
                }

                
                // document.getElementById('chosenDate').innerHTML = "<input type='hidden' name='chosenDate' value='" + date + "'>";
                // newDay = new Date(dateList[dayCounter]);
                // disableButton(newDay);
                // var diffDays = Math.round(Math.abs((newDay - currentDay) / oneDay));
                // console.log('diffDays: ', diffDays);
                // // console.log('week offset: ', Math.floor((diffDays)/7));
                // var weeklyOffset = (Math.floor((diffDays)/7));
                // console.log('weekOffset: ', weeklyOffset);
                
                // console.log('dayCounter: ', dayCounter);
                // console.log(weekActivities[dayCounter]);
                // populateMainSection()
            }
            


        </script>

        

        


        <br><br>
        <!-- <script>
            function deleteAllCookies() {
              var cookies = document.cookie.split(";");
            //   console.log(cookies);
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = cookies[i];
                  var eqPos = cookie.indexOf("=");
                  var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                  console.log('name: ', name);
                  document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
                //   console.log(document.cookie);
              }
              location.reload();
            // window.location.href = "/";
            } 

            function deleteAllCookies2 () {
                var cookies = document.cookie.split("; ");
                console.log(cookies);
                for (var c = 0; c < cookies.length; c++) {
                    var d = window.location.hostname.split(".");
                    while (d.length > 0) {
                        var cookieBase = encodeURIComponent(cookies[c].split(";")[0].split("=")[0]) + '=; expires=Thu, 01-Jan-1970 00:00:01 GMT; domain=' + d.join('.') + ' ;path=';
                        var p = location.pathname.split('/');
                        document.cookie = cookieBase + '/';
                        while (p.length > 0) {
                            document.cookie = cookieBase + p.join('/');
                            p.pop();
                        };
                        d.shift();
                    }
                }
                location.reload();
            };

        </script> -->

        <br><br>
        <a href="/normalRoutine">
            <button>My Normal Routine</button>
        </a>

        <br><br>
        <a href="/calendar">
            <button>My History</button>
        </a>

        <br><br>
        <button onclick="logout()">Log Out</button>
    </body>

</html>