<!DOCTYPE html>
<html>
    <head>
        <title><%= title %></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel='stylesheet' href='/stylesheets/style.css' />
        <link rel="manifest" href="/manifest.json">
        <script type="module" src="/pwabuilder-sw-register.js"></script>
        <!-- <script type="module" src="https://cdn.jsdelivr.net/npm/@pwabuilder/pwaauth@latest/dist/pwa-auth.min.js"></script>  -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!-- <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet"> -->
        <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
        <script type="text/javascript" src="/javascripts/routineDescription.js"></script> 
        <script type="text/javascript" src="/javascripts/getCook.js"></script> 
    </head>
   
    
    <body>

        <!-- Calendar adapted from https://codepen.io/nitroduck/pen/pmQoOY -->

        <h1><%= title%></h1>

        <div class="calendar" id="main">
            <!-- <div class="jumbotron"> -->
                <p class="text-center" style="text-align: center; font-size: 5vw;">
                <a id="left" href="#">
                    <i> &#8592; </i>
                </a>
                <span>&nbsp;</span>
                <span id="month"> </span>
                <span>&nbsp;</span>
                <span id="year"> </span>
                <span>&nbsp;</span>
                <a id="right" href="#">
                    <!-- <i> &#8594; </i> -->
                    <!-- <i class="fas fa-chevron-right"></i> -->
                </a>
            </p>
            <!-- </div> -->
            <div class="row">
                <div class="col-sm-10 col-sm-offset-1">
                    <table class="table" ></table>
                </div>
            </div>
        </div>

        <!-- <button id="myBtn">Open Modal</button> -->

        <!-- The Modal -->
        <div id="myModal" class="modal">

            <!-- Modal content -->
            <div class="modal-content">
                <span class="close">&times;</span>
                <p id="modalText"></p>
            </div>
        </div>

        <br><br>
        <a href="/">
            <button>Log Activity</button>
        </a>

        <script>
            if (!(navigator.onLine) && (!(getCook('accessToken')))) {
                window.location.href = "/loginUser"
            }

            var activities = <%- activities %>;
            // console.log(activities);

            // $(document).ready(function() {
                var currentDate = new Date();
                function generateCalendar(d) {
                    function monthDays(month, year) {
                        // console.log('monthDays month: ', month);
                        var result = [];
                        var days = new Date(year, month, 0).getDate();
                        for (var i = 1; i <= days; i++) {
                            result.push(i);
                        }
                        return result;
                    }
                    Date.prototype.monthDays = function() {
                        var d = new Date(this.getFullYear(), this.getMonth() + 1, 0);
                        return d.getDate();
                    };
                    var details = {
                        // totalDays: monthDays(d.getMonth(), d.getFullYear()),
                        totalDays: d.monthDays(),
                        weekDays: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
                        months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                    };
                    var start = new Date(d.getFullYear(), d.getMonth()).getDay();
                    // console.log(d.getFullYear());
                    // console.log(d.getMonth());

                    var cal = [];
                    var day = 1;
                    for (var i = 0; i <= 6; i++) {
                        cal.push(['<tr>']);
                        for (var j = 0; j < 7; j++) {
                            if (i === 0) {
                                cal[i].push('<td>' + details.weekDays[j] + '</td>');
                                
                            } else if (day > details.totalDays) {
                            cal[i].push('<td>&nbsp;</td>');
                            } else {
                                if (i === 1 && j < start) {
                                    cal[i].push('<td>&nbsp;</td>');
                                } else {
                                    // console.log('day? ', day);
                                    // console.log(d.getFullYear() + '-' + (d.getMonth() +1) + "-" + day);
                                    var interDate = d.getFullYear() + '-' + (d.getMonth()+1) + "-" + day;
                                    // console.log(activities[interDate]);
                                    if (activities[interDate]) {
                                   
                                            cal[i].push('<td class="day dot" onclick="openModal('+"'" + interDate + "'" + ')">' + day++ + '</td>');
                                       
                                    } else {
                                        cal[i].push('<td class="day">' + day++ + '</td>');
                                    }
                                    
                                    
                                }
                            }
                        }
                        cal[i].push('</tr>');
                    }
                    cal = cal.reduce(function(a, b) {
                        return a.concat(b);
                    }, []).join('');
                    $('table').append(cal);
                    $('#month').text(details.months[d.getMonth()]);
                    $('#year').text(d.getFullYear());
                    $('td.day').mouseover(function() {
                        $(this).addClass('hover');
                    }).mouseout(function() {
                        $(this).removeClass('hover');
                    });
                }

                $('#left').click(function() {
                    $('table').text('');
                    // $('table').html('<tr></tr>');
                    actualDate = new Date();
                    document.getElementById('right').innerHTML = "<i> &#8594; </i>";
                        if (currentDate.getMonth() === 0) {
                            currentDate = new Date(currentDate.getFullYear() - 1, 11);
                            generateCalendar(currentDate);
                        } else {
                            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1)
                            generateCalendar(currentDate);
                        }
                });
                $('#right').click(function() {
                    $('table').html('');
                    actualDate = new Date();
                        if (currentDate.getMonth() === 11) {
                            currentDate = new Date(currentDate.getFullYear() + 1, 0); 
                            if ((currentDate.getMonth() == actualDate.getMonth()) && (currentDate.getFullYear() == actualDate.getFullYear())) {
                                document.getElementById('right').innerHTML = "";
                            } 
                            generateCalendar(currentDate);
                        } else {
                            currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1)
                            if ((currentDate.getMonth() == actualDate.getMonth()) && (currentDate.getFullYear() == actualDate.getFullYear())) {
                                document.getElementById('right').innerHTML = "";
                            } 
                            generateCalendar(currentDate);
                        }
                    // $('test').html('');
                });
                generateCalendar(currentDate);
            // });

            // Get the modal
            var modal = document.getElementById("myModal");

            // Get the <span> element that closes the modal
            var span = document.getElementsByClassName("close")[0];

            // When the user clicks on <span> (x), close the modal
            span.onclick = function() {
                modal.style.display = "none";
            }

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            function openModal(date) {
                document.getElementById('modalText').innerHTML = '<p style="text-align: center">'+date+'</p>';
                routineDescription(activities[date], 'modalText');
                modal.style.display = "block";
            }

        </script>

    </body>
</html>